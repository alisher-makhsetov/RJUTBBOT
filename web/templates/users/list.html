<!-- web/templates/users/list.html -->
{% extends 'base.html' %}

{% block title %}Xodimlar - RJUTB Admin{% endblock %}

{% block breadcrumb %}
<a href="{{ url_for('dashboard.index') }}">
    <i class="fas fa-home"></i>
    <span>Bosh Sahifa</span>
</a>
<span>/</span>
<span class="current">Xodimlar</span>
{% endblock %}

{% block content %}
<style>
    .page-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 30px;
    }

    .page-header h1 {
        font-size: 2rem;
        font-weight: 800;
        color: #f8fafc;
        display: flex;
        align-items: center;
        gap: 12px;
    }

    /* Statistics Cards */
    .stats-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); /* ‚Üê TUZATILDI! */
        gap: 20px;
        margin-bottom: 30px;
    }

    .stat-card {
        background: linear-gradient(135deg, rgba(99, 102, 241, 0.1), rgba(139, 92, 246, 0.05));
        border: 1px solid rgba(99, 102, 241, 0.2);
        border-radius: 12px;
        padding: 25px;
        transition: all 0.3s ease;
        display: flex;
        flex-direction: column;
        align-items: center;
        text-align: center;
    }

    .stat-card:hover {
        transform: translateY(-5px);
        box-shadow: 0 10px 30px rgba(99, 102, 241, 0.2);
    }

    .stat-card.success {
        background: linear-gradient(135deg, rgba(236, 72, 153, 0.1), rgba(219, 39, 119, 0.05));
        border-color: rgba(236, 72, 153, 0.2);
    }

    .stat-card.info {
        background: linear-gradient(135deg, rgba(16, 185, 129, 0.1), rgba(5, 150, 105, 0.05));
        border-color: rgba(16, 185, 129, 0.2);
    }

    .stat-card.warning {
        background: linear-gradient(135deg, rgba(245, 158, 11, 0.1), rgba(217, 119, 6, 0.05));
        border-color: rgba(245, 158, 11, 0.2);
    }

    .stat-card h5 {
        font-size: 0.8rem;
        color: #94a3b8;
        font-weight: 600;
        margin-bottom: 12px;
        text-transform: uppercase;
        letter-spacing: 0.5px;
    }

    .stat-card h2 {
        font-size: 2.8rem;
        color: #f8fafc;
        font-weight: 800;
        margin: 0;
        line-height: 1;
    }

    /* Til Taqsimoti */
    .stat-card.lang-card {
        padding: 20px;
    }

    .lang-stats {
        display: flex;
        gap: 20px;
        width: 100%;
        justify-content: space-around;
    }

    .lang-item {
        text-align: center;
        flex: 1;
    }

    .lang-item .count {
        font-size: 2rem;
        font-weight: 800;
        margin-bottom: 5px;
        color: #f8fafc;
    }

    .lang-item .label {
        font-size: 0.75rem;
        color: #94a3b8;
        font-weight: 600;
        text-transform: uppercase;
    }

    /* Filters */
    .filters {
        background: rgba(30, 41, 59, 0.6);
        border: 1px solid rgba(99, 102, 241, 0.1);
        border-radius: 12px;
        padding: 20px;
        margin-bottom: 25px;
        display: flex;
        gap: 15px;
        flex-wrap: wrap;
        align-items: flex-end;
    }

    .filter-group {
        flex: 1;
        min-width: 200px;
    }

    .filter-group label {
        display: block;
        color: #94a3b8;
        font-size: 0.85rem;
        font-weight: 600;
        margin-bottom: 8px;
    }

    .filter-group input,
    .filter-group select {
        width: 100%;
        padding: 10px 15px;
        background: rgba(15, 23, 42, 0.8);
        border: 1px solid rgba(51, 65, 85, 0.4);
        border-radius: 8px;
        color: #f8fafc;
        font-size: 0.95rem;
    }

    .filter-group input:focus,
    .filter-group select:focus {
        outline: none;
        border-color: #6366f1;
        box-shadow: 0 0 0 3px rgba(99, 102, 241, 0.1);
    }

    .btn-primary {
        display: inline-flex;
        align-items: center;
        gap: 10px;
        padding: 12px 24px;
        background: linear-gradient(135deg, #6366f1, #4f46e5);
        color: white;
        text-decoration: none;
        border-radius: 10px;
        font-weight: 600;
        transition: all 0.3s ease;
        border: none;
        cursor: pointer;
    }

    .btn-primary:hover {
        transform: translateY(-2px);
        box-shadow: 0 10px 20px rgba(99, 102, 241, 0.3);
    }

    /* Table */
    .table-container {
        background: rgba(30, 41, 59, 0.6);
        border: 1px solid rgba(99, 102, 241, 0.1);
        border-radius: 12px;
        overflow: hidden;
        margin-bottom: 25px;
    }

    table {
        width: 100%;
        border-collapse: collapse;
    }

    thead {
        background: rgba(99, 102, 241, 0.1);
    }

    th {
        padding: 15px 20px;
        text-align: left;
        color: #f8fafc;
        font-weight: 700;
        font-size: 0.9rem;
        text-transform: uppercase;
        letter-spacing: 0.5px;
    }

    tbody tr {
        border-bottom: 1px solid rgba(99, 102, 241, 0.05);
        transition: all 0.3s ease;
    }

    tbody tr:hover {
        background: rgba(99, 102, 241, 0.08);
    }

    td {
        padding: 15px 20px;
        color: #94a3b8;
    }

    .user-name {
        color: #f8fafc;
        font-weight: 600;
    }

    .badge {
        display: inline-block;
        padding: 4px 10px;
        border-radius: 6px;
        font-size: 0.75rem;
        font-weight: 600;
    }

    .badge-uz {
        background: rgba(99, 102, 241, 0.1);
        color: #6366f1;
        border: 1px solid rgba(99, 102, 241, 0.2);
    }

    .badge-ru {
        background: rgba(239, 68, 68, 0.1);
        color: #ef4444;
        border: 1px solid rgba(239, 68, 68, 0.2);
    }

    .badge-kk {
        background: rgba(16, 185, 129, 0.1);
        color: #10b981;
        border: 1px solid rgba(16, 185, 129, 0.2);
    }

    .badge-active {
        background: rgba(16, 185, 129, 0.1);
        color: #10b981;
        border: 1px solid rgba(16, 185, 129, 0.2);
    }

    .badge-inactive {
        background: rgba(239, 68, 68, 0.1);
        color: #ef4444;
        border: 1px solid rgba(239, 68, 68, 0.2);
    }

    /* Actions Button */
    .btn-sm {
        padding: 6px 12px;
        border-radius: 6px;
        font-size: 0.85rem;
        text-decoration: none;
        transition: all 0.3s ease;
        border: none;
        cursor: pointer;
        display: inline-flex;
        align-items: center;
        gap: 5px;
    }

    .btn-delete {
        background: rgba(239, 68, 68, 0.1);
        color: #ef4444;
        border: 1px solid rgba(239, 68, 68, 0.2);
    }

    .btn-delete:hover {
        background: rgba(239, 68, 68, 0.2);
        transform: translateY(-2px);
    }

    .btn-edit {
        background: rgba(16, 185, 129, 0.1);
        color: #10b981;
        border: 1px solid rgba(16, 185, 129, 0.2);
    }

    .btn-edit:hover {
        background: rgba(16, 185, 129, 0.2);
        transform: translateY(-2px);
    }

    /* Pagination */
    .pagination {
        display: flex;
        justify-content: space-between;
        align-items: center;
        background: rgba(30, 41, 59, 0.6);
        border: 1px solid rgba(99, 102, 241, 0.1);
        border-radius: 12px;
        padding: 20px;
    }

    .pagination-info {
        color: #94a3b8;
        font-size: 0.9rem;
    }

    .pagination-controls {
        display: flex;
        gap: 10px;
        align-items: center;
    }

    .pagination-btn {
        padding: 8px 16px;
        background: rgba(99, 102, 241, 0.1);
        border: 1px solid rgba(99, 102, 241, 0.2);
        color: #6366f1;
        border-radius: 8px;
        text-decoration: none;
        transition: all 0.3s ease;
        font-weight: 600;
        font-size: 0.9rem;
    }

    .pagination-btn:hover:not(.disabled) {
        background: rgba(99, 102, 241, 0.2);
        transform: translateY(-2px);
    }

    .pagination-btn.disabled {
        opacity: 0.5;
        cursor: not-allowed;
        pointer-events: none;
    }

    .pagination-btn.active {
        background: linear-gradient(135deg, #6366f1, #4f46e5);
        color: white;
    }

    /* Empty state */
    .empty-state {
        text-align: center;
        padding: 60px 20px;
        color: #64748b;
    }

    .empty-state i {
        font-size: 4rem;
        margin-bottom: 20px;
        opacity: 0.3;
    }

    .empty-state h3 {
        font-size: 1.2rem;
        margin-bottom: 10px;
        color: #94a3b8;
    }

    /* SweetAlert2 Dark Theme */
    .swal-dark {
        border: 1px solid rgba(99, 102, 241, 0.2) !important;
        box-shadow: 0 20px 60px rgba(0, 0, 0, 0.5) !important;
    }

    .swal2-icon {
        border-color: rgba(99, 102, 241, 0.3) !important;
    }

    .swal2-html-container {
        color: #f8fafc !important;
    }
</style>

<div class="page-header">
    <h1>
        <i class="fas fa-users"></i>
        <span>Xodimlar</span>
    </h1>
</div>

<!-- Statistics Cards -->
<div class="stats-grid">
    <div class="stat-card">
        <h5><i class="fas fa-users"></i> JAMI USERLAR</h5>
        <h2>{{ stats.total }}</h2>
    </div>
    <div class="stat-card success">
        <h5><i class="fas fa-check-circle"></i> FAOL</h5>
        <h2>{{ stats.active }}</h2>
    </div>
    <div class="stat-card info">
        <h5><i class="fas fa-calendar-day"></i> BUGUN</h5>
        <h2>{{ stats.today }}</h2>
    </div>
    <div class="stat-card warning lang-card">
        <h5><i class="fas fa-globe"></i> TIL TAQSIMOTI</h5>
        <div class="lang-stats">
            <div class="lang-item">
                <div class="count">{{ stats.uz }}</div>
                <div class="label">UZ</div>
            </div>
            <div class="lang-item">
                <div class="count">{{ stats.ru }}</div>
                <div class="label">RU</div>
            </div>
            <div class="lang-item">
                <div class="count">{{ stats.kk }}</div>
                <div class="label">KK</div>
            </div>
        </div>
    </div>
</div>

<!-- Filters -->
<form method="GET" class="filters">
    <div class="filter-group">
        <label for="search"><i class="fas fa-search"></i> Qidirish</label>
        <input type="text" id="search" name="search" value="{{ search }}" placeholder="Ism, telefon, username...">
    </div>

    <div class="filter-group">
        <label for="language"><i class="fas fa-globe"></i> Til</label>
        <select id="language" name="language">
            <option value="">Barcha tillar</option>
            <option value="uz" {% if language == 'uz' %}selected{% endif %}>O'zbek</option>
            <option value="ru" {% if language == 'ru' %}selected{% endif %}>Rus</option>
            <option value="kk" {% if language == 'kk' %}selected{% endif %}>Qoraqalpoq</option>
        </select>
    </div>

    <div class="filter-group">
        <label for="is_active"><i class="fas fa-toggle-on"></i> Holat</label>
        <select id="is_active" name="is_active">
            <option value="">Barcha</option>
            <option value="true" {% if is_active == 'true' %}selected{% endif %}>Faol</option>
            <option value="false" {% if is_active == 'false' %}selected{% endif %}>Nofaol</option>
        </select>
    </div>

    <div class="filter-group">
        <label for="per_page"><i class="fas fa-list"></i> Sahifada</label>
        <select id="per_page" name="per_page">
            <option value="10" {% if per_page == 10 %}selected{% endif %}>10 ta</option>
            <option value="20" {% if per_page == 20 %}selected{% endif %}>20 ta</option>
            <option value="30" {% if per_page == 30 %}selected{% endif %}>30 ta</option>
            <option value="50" {% if per_page == 50 %}selected{% endif %}>50 ta</option>
        </select>
    </div>

    <div class="filter-group" style="display: flex; align-items: flex-end;">
        <button type="submit" class="btn-primary">
            <i class="fas fa-filter"></i>
            <span>Filtr</span>
        </button>
    </div>
</form>

<!-- Table -->
<div class="table-container">
    {% if users %}
    <table>
        <thead>
            <tr>
                <th>ID</th>
                <th>TO'LIQ ISM</th>
                <th>USERNAME</th>
                <th>TELEFON</th>
                <th>TIL</th>
                <th>HOLAT</th>
                <th>RO'YXATDAN O'TGAN</th>
                <th>AMALLAR</th>
            </tr>
        </thead>
        <tbody>
            {% for user in users %}
            <tr>
                <td><strong>#{{ user.id }}</strong></td>
                <td class="user-name">{{ user.full_name }}</td>
                <td>@{{ user.username or '-' }}</td>
                <td>{{ user.phone_number }}</td>
                <td>
                    <span class="badge badge-{{ user.language_code }}">
                        {{ user.language_code.upper() }}
                    </span>
                </td>
                <td>
                    {% if user.is_active %}
                    <span class="badge badge-active">
                        <i class="fas fa-check"></i> Faol
                    </span>
                    {% else %}
                    <span class="badge badge-inactive">
                        <i class="fas fa-times"></i> Faol emas
                    </span>
                    {% endif %}
                </td>
                <td>{{ user.created_at.strftime('%Y-%m-%d %H:%M') }}</td>
                <td>
                    {% if user.is_active %}
                    <button type="button" class="btn-sm btn-delete" title="Bloklash"
                            onclick="confirmBlock({{ user.id }}, '{{ user.full_name }}')">
                        <i class="fas fa-ban"></i>
                    </button>
                    {% else %}
                    <button type="button" class="btn-sm btn-edit" title="Blokdan chiqarish"
                            onclick="confirmUnblock({{ user.id }}, '{{ user.full_name }}')">
                        <i class="fas fa-check-circle"></i>
                    </button>
                    {% endif %}
                </td>
            </tr>
            {% endfor %}
        </tbody>
    </table>
    {% else %}
    <div class="empty-state">
        <i class="fas fa-users"></i>
        <h3>Xodimlar topilmadi</h3>
        <p>Filtrlarni o'zgartiring yoki qidiruv so'rovini yangilang</p>
    </div>
    {% endif %}
</div>

<!-- Pagination -->
{% if users %}
<div class="pagination">
    <div class="pagination-info">
        Jami: <strong>{{ total }}</strong> ta xodim |
        Sahifa: <strong>{{ page }}</strong> / <strong>{{ (total // per_page) + 1 if total % per_page else total // per_page }}</strong>
    </div>

    <div class="pagination-controls">
        {% if page > 1 %}
        <a href="{{ url_for('users.list_users', page=1, per_page=per_page, search=search, language=language, is_active=is_active) }}" class="pagination-btn">
            <i class="fas fa-angle-double-left"></i>
        </a>
        <a href="{{ url_for('users.list_users', page=page - 1, per_page=per_page, search=search, language=language, is_active=is_active) }}" class="pagination-btn">
            <i class="fas fa-angle-left"></i> Oldingi
        </a>
        {% else %}
        <span class="pagination-btn disabled">
            <i class="fas fa-angle-double-left"></i>
        </span>
        <span class="pagination-btn disabled">
            <i class="fas fa-angle-left"></i> Oldingi
        </span>
        {% endif %}

        <span class="pagination-btn active">{{ page }}</span>

        {% if page * per_page < total %}
        <a href="{{ url_for('users.list_users', page=page + 1, per_page=per_page, search=search, language=language, is_active=is_active) }}" class="pagination-btn">
            Keyingi <i class="fas fa-angle-right"></i>
        </a>
        <a href="{{ url_for('users.list_users', page=(total // per_page) + 1 if total % per_page else total // per_page, per_page=per_page, search=search, language=language, is_active=is_active) }}" class="pagination-btn">
            <i class="fas fa-angle-double-right"></i>
        </a>
        {% else %}
        <span class="pagination-btn disabled">
            Keyingi <i class="fas fa-angle-right"></i>
        </span>
        <span class="pagination-btn disabled">
            <i class="fas fa-angle-double-right"></i>
        </span>
        {% endif %}
    </div>
</div>
{% endif %}

<script>
function confirmBlock(userId, userName) {
    Swal.fire({
        title: '<i class="fas fa-user-lock" style="color: #ef4444; font-size: 2.5rem; margin-bottom: 10px;"></i>',
        html: `
            <div style="text-align: center; padding: 10px;">
                <h3 style="font-size: 1.3rem; margin-bottom: 15px; color: #f8fafc;">
                    <strong>${userName}</strong> bloklansinmi?
                </h3>
                <div style="background: rgba(239, 68, 68, 0.1); padding: 15px; border-radius: 8px; border-left: 3px solid #ef4444; text-align: left;">
                    <p style="margin: 8px 0; color: #f8fafc;"><i class="fas fa-times-circle" style="color: #ef4444; margin-right: 8px;"></i> Bot ishlamaydi</p>
                    <p style="margin: 8px 0; color: #f8fafc;"><i class="fas fa-lock" style="color: #ef4444; margin-right: 8px;"></i> Barcha funksiyalar yopiladi</p>
                    <p style="margin: 8px 0; color: #f8fafc;"><i class="fas fa-ban" style="color: #ef4444; margin-right: 8px;"></i> Xabarlar yetib bormaydi</p>
                </div>
            </div>
        `,
        showCancelButton: true,
        confirmButtonColor: '#ef4444',
        cancelButtonColor: '#64748b',
        confirmButtonText: '<i class="fas fa-user-lock"></i> Ha, bloklash',
        cancelButtonText: '<i class="fas fa-times"></i> Bekor qilish',
        background: '#1e293b',
        color: '#f8fafc',
        customClass: {
            popup: 'swal-dark',
            title: 'swal-title'
        },
        showClass: {
            popup: 'animate__animated animate__fadeInDown'
        },
        hideClass: {
            popup: 'animate__animated animate__fadeOutUp'
        }
    }).then((result) => {
        if (result.isConfirmed) {
            const form = document.createElement('form');
            form.method = 'POST';
            form.action = `/users/toggle_active/${userId}`;
            document.body.appendChild(form);
            form.submit();
        }
    });
}

function confirmUnblock(userId, userName) {
    Swal.fire({
        title: '<i class="fas fa-user-check" style="color: #10b981; font-size: 2.5rem; margin-bottom: 10px;"></i>',
        html: `
            <div style="text-align: center; padding: 10px;">
                <h3 style="font-size: 1.3rem; margin-bottom: 15px; color: #f8fafc;">
                    <strong>${userName}</strong> blokdan chiqarilsinmi?
                </h3>
                <div style="background: rgba(16, 185, 129, 0.1); padding: 15px; border-radius: 8px; border-left: 3px solid #10b981; text-align: left;">
                    <p style="margin: 8px 0; color: #f8fafc;"><i class="fas fa-check-circle" style="color: #10b981; margin-right: 8px;"></i> Bot ishlay boshlaydi</p>
                    <p style="margin: 8px 0; color: #f8fafc;"><i class="fas fa-unlock" style="color: #10b981; margin-right: 8px;"></i> Barcha funksiyalar ochiladi</p>
                </div>
            </div>
        `,
        showCancelButton: true,
        confirmButtonColor: '#10b981',
        cancelButtonColor: '#64748b',
        confirmButtonText: '<i class="fas fa-user-check"></i> Ha, chiqarish',
        cancelButtonText: '<i class="fas fa-times"></i> Bekor qilish',
        background: '#1e293b',
        color: '#f8fafc',
        customClass: {
            popup: 'swal-dark',
            title: 'swal-title'
        },
        showClass: {
            popup: 'animate__animated animate__fadeInDown'
        },
        hideClass: {
            popup: 'animate__animated animate__fadeOutUp'
        }
    }).then((result) => {
        if (result.isConfirmed) {
            const form = document.createElement('form');
            form.method = 'POST';
            form.action = `/users/toggle_active/${userId}`;
            document.body.appendChild(form);
            form.submit();
        }
    });
}
</script>
{% endblock %}